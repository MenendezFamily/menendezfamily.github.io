function loadImage(a){var b=new Image;return b.src=a,b}function ready(a,b){var c=b.shift();land=topojson.feature(c,c.objects.land),borders=topojson.mesh(c,c.objects.countries,function(a,b){return a!==b}),b.forEach(function(a){for(var b in a.objects)if(dataToLoad[b])dataToLoad[b].feature=topojson.feature(a,a.objects[b]);else if(b.endsWith("_buffer")){var c=b.removeRight("_buffer");dataToLoad[c]&&(dataToLoad[c].buffer=topojson.feature(a,a.objects[b]))}}),drawBuffer("momdad"),drawBuffer("transam"),drawBuffer("at"),drawBuffer("camino"),d3.select(window).on("resize",resize),resize(),svg.on("mousemove",function(){isRotating||(lonRotate===lon.us&&d3.event.clientX>projection([lon["us-edge"],latCenter])[0]?rotate(lon.spain):lonRotate===lon.spain&&d3.event.clientX<projection([lon["spain-edge"],latCenter])[0]?rotate(lon.us):lonRotate!==lon.us&&lonRotate!==lon.spain&&rotate(d3.event.clientX<width/2?lon.us:lon.spain))})}function drawBuffer(a){function b(){doMouseover(a,!1)}function c(){doMouseover(a,!0)}function d(){isRotating||setPathStroke(a,pathStyle["stroke-width"]),setTextShadow(a,0)}dataToLoad[a]["buffer-element"]=svg.append("a").attr("class","buffer").attr("xlink:href",dataToLoad[a].url).append("path").datum(dataToLoad[a].buffer),dataToLoad[a]["link-element"]=d3.select(".copy ."+a),dataToLoad[a]["link-element"].style("transition-duration",transitionDurationStroke+"ms"),dataToLoad[a]["buffer-element"].on("mouseover",b),dataToLoad[a]["link-element"].on("mouseover",c),dataToLoad[a]["buffer-element"].on("mouseout",d),dataToLoad[a]["link-element"].on("mouseout",d)}function setPathStroke(a,b){d3.transition().duration(transitionDurationStroke).tween("width",function(){var c=d3.interpolate(dataToLoad[a]["stroke-width"],b);return function(b){dataToLoad[a]["stroke-width"]=c(b),draw()}})}function setTextShadow(a,b){var c="0px 0px "+b+"px";b>0&&(c+=" "+dataToLoad[a].color),dataToLoad[a]["link-element"].style("text-shadow",c)}function doMouseover(a,b){(!isRotating||b)&&(resetPathStrokes(),isRotating||setPathStroke(a,pathStyle.hover["stroke-width"]),rotate(dataToLoad[a]["center-lon"],b?a:null)),setTextShadow(a,blurRadius)}function resize(){c.clearRect(0,0,width,height);var a=parseInt(d3.select(".container").style("height"),10)+parseInt(d3.select("#footer").style("height"),10);width=parseInt(map.style("width"),10),height=Math.min(Math.round(width*mapRatio),window.innerHeight-a),scale=Math.min(width*maxWidthRatio,height*maxHeightRatio),draw(),drawSvg()}function draw(){projection.rotate([-lonRotate,-latRotate]).center([0,latBottom-latRotate]).scale(scale).translate([width/2,height]),canvas.attr("width",width).attr("height",height),firstRun&&(firstRun=!1,canvas.attr("class","ready")),map.style("height",height+"px"),c.clearRect(0,0,width,height),c.strokeStyle=graticuleStyle.stroke,c.lineWidth=graticuleStyle["stroke-width"],c.beginPath(),path(graticule()),c.stroke(),c.fillStyle=c.createPattern(landStyle["background-image"],"repeat"),c.strokeStyle=landStyle.stroke,c.lineWidth=landStyle["stroke-width"],c.beginPath(),path(land),c.fill(),c.stroke(),c.beginPath(),path(borders),c.stroke();for(var a in dataToLoad)c.strokeStyle=dataToLoad[a].color,c.lineWidth=dataToLoad[a]["stroke-width"],c.beginPath(),path(dataToLoad[a].feature),c.stroke();var b=c.createLinearGradient(0,height-shadowHeight,0,height+shadowHeight);b.addColorStop(0,"transparent"),b.addColorStop(1,colors["gray-dark"]),c.fillStyle=b,c.fillRect(0,height-shadowHeight,width,height)}function drawSvg(){svg.attr("width",width).attr("height",height);for(var a in dataToLoad)dataToLoad[a]["buffer-element"].attr("d",svgPath)}function rotate(a,b){var c=-projection.rotate()[0];c!==a&&(isRotating=!0,resetPathStrokes(),b&&(dataToLoad[b]["stroke-width"]=pathStyle.hover["stroke-width"]),d3.transition().duration(transitionDurationWorld).tween("rotate",function(){var b=d3.interpolate(c,a);return function(a){lonRotate=b(a),draw()}}).each("end",function(){isRotating=!1,drawSvg()}))}function resetPathStrokes(){for(var a in dataToLoad)dataToLoad[a]["stroke-width"]=pathStyle["stroke-width"];draw()}var lonRotate=-60,latRotate=10,latBottom=24,latCenter=30,mapRatio=.5,maxWidthRatio=.6,maxHeightRatio=1.3,width=0,height=0,scale=0,colors={red:"#e41a1c",blue:"#377eb8",green:"#4daf4a",purple:"#984ea3",orange:"#ff7f00",yellow:"#ffff33",brown:"#a65628",pink:"#f781bf","gray-darker":"#272B30","gray-dark":"#3A3F44",gray:"#52575C","gray-light":"#7A8288","gray-lighter":"#999"},transitionDurationStroke=300,transitionDurationWorld=500,shadowHeight=4,blurRadius=3,lon={us:-100,spain:-7,"us-edge":-65,"spain-edge":-20},pathStyle={"stroke-width":3,hover:{"stroke-width":5}},graticuleStyle={stroke:colors.gray,"stroke-width":.5},landStyle={stroke:colors.gray,"stroke-width":1,"background-image":loadImage("images/mochaGrunge.jpg")},dataToLoad={momdad:{url:"http://mannymarsha.wordpress.com/",color:colors.purple,"stroke-width":pathStyle["stroke-width"],"center-lon":lon.us},transam:{url:"http://picasaweb.com/nathanbiketrip",color:colors.green,"stroke-width":pathStyle["stroke-width"],"center-lon":lon.us},at:{url:"at/",color:colors.brown,"stroke-width":pathStyle["stroke-width"],"center-lon":lon.us},camino:{url:"http://blog.travelpod.com/travel-blog/aggiesontheway/2/tpod.html",color:colors.red,"stroke-width":pathStyle["stroke-width"],"center-lon":lon.spain}},isRotating=!1,firstRun=!0,map=d3.select("#map"),canvas=map.append("canvas"),svg=map.append("svg"),c=canvas.node().getContext("2d"),graticule=d3.geo.graticule(),projection=d3.geo.orthographic().clipAngle(90),path=d3.geo.path().projection(projection).context(c),svgPath=d3.geo.path().projection(projection);"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)}),String.prototype.removeRight=function(a){return this.substring(0,this.length-a.length)};var land,borders,queue=queue().defer(d3.json,"../data/world-110m.json");for(var key in dataToLoad)queue.defer(d3.json,"../data/"+key+".json"),queue.defer(d3.json,"../data/"+key+"_buffer.json");queue.awaitAll(ready);